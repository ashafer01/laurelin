version: 2

workflows:
  version: 2
  test:
    jobs:
      - test-3.6

jobs:
  test-3.6: &test-template
    docker:
      - image: circleci/python:3.6-jessie
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Setup
          command: |
            docker pull ashafer01/openldap:1.3.0
            docker pull jtgasper3/389ds-basic
            docker run --name openldap -p 127.0.0.1:10389:389 -p 127.0.0.1:10636:636 --env LDAP_TLS_VERIFY_CLIENT=never --detach ashafer01/openldap:1.3.0 --loglevel debug
            docker run --name 389ds -p 127.0.0.1:11389:389 --detach jtgasper3/389ds-basic
            pip install -U pip
            pip install setuptools
      - run:
          name: Test
          command: |
            nosetests
            ./scripts/integration_test.py
            docker logs openldap
      - run:
          name: Build
          command: |
            ./scripts/build.sh python pip --force
            pip install ./dist/*.whl